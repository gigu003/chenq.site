<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.238">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="陈琼">
<meta name="dcterms.date" content="2022-02-21">
<meta name="keywords" content="R, 科研作图, ggplot2">

<title>普癌新声 - 利用ggplot2制作金字塔图，展示人口结构数据</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../favicon.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<style>
    .quarto-title-block .quarto-title-banner,
    .quarto-title-block .quarto-title-banner h1,
    .quarto-title-block .quarto-title-banner h2,
    .quarto-title-block .quarto-title-banner h3,
    .quarto-title-block .quarto-title-banner h4,
    .quarto-title-block .quarto-title-banner h5,
    .quarto-title-block .quarto-title-banner h6
    {
      color: #c8c8c8;
    }
    </style>
<script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?c07d97fb46a2cbcc09d408cf3a281e08";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
    


<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="普癌新声 - 利用ggplot2制作金字塔图，展示人口结构数据">
<meta property="og:description" content="">
<meta property="og:site-name" content="普癌新声">
<meta name="twitter:title" content="普癌新声 - 利用ggplot2制作金字塔图，展示人口结构数据">
<meta name="twitter:description" content="">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">普癌新声</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html" rel="" target=""><i class="bi bi-house" role="img">
</i> 
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../qsight/" rel="" target=""><i class="bi bi-tropical-storm" role="img">
</i> 
 <span class="menu-text">Qsight博客</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://diary.chenq.site" rel="" target=""><i class="bi bi-pen" role="img">
</i> 
 <span class="menu-text">随笔录</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://canregtools.chenq.site" rel="" target=""><i class="bi bi-hexagon" role="img">
</i> 
 <span class="menu-text">Packages</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../publications/" rel="" target=""><i class="bi bi-journal-medical" role="img">
</i> 
 <span class="menu-text">出版作品</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../slides/" rel="" target=""><i class="bi bi-file-slides-fill" role="img">
</i> 
 <span class="menu-text">Slides</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">关于</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="../../qsight/index.xml" rel="" target=""><i class="bi bi-rss" role="img" aria-label="RSS">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">利用ggplot2制作金字塔图，展示人口结构数据</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">R</div>
                <div class="quarto-category">科研作图</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">作者</div>
      <div class="quarto-title-meta-contents">
               <p>陈琼 </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">发表时间</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 21, 2022</p>
      </div>
    </div>
    
      <div>
      <div class="quarto-title-meta-heading">更新时间</div>
      <div class="quarto-title-meta-contents">
        <p class="date-modified">September 25, 2023</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">本页内容</h2>
   
  <ul>
  <li><a href="#什么是人口金字塔图" id="toc-什么是人口金字塔图" class="nav-link active" data-scroll-target="#什么是人口金字塔图"><span class="header-section-number">1</span> 什么是人口金字塔图？</a></li>
  <li><a href="#用到哪些r包" id="toc-用到哪些r包" class="nav-link" data-scroll-target="#用到哪些r包"><span class="header-section-number">2</span> 用到哪些R包？</a></li>
  <li><a href="#加载这些r包" id="toc-加载这些r包" class="nav-link" data-scroll-target="#加载这些r包"><span class="header-section-number">3</span> 加载这些R包</a></li>
  <li><a href="#数据处理" id="toc-数据处理" class="nav-link" data-scroll-target="#数据处理"><span class="header-section-number">4</span> 数据处理</a></li>
  <li><a href="#制作金字塔图的思路" id="toc-制作金字塔图的思路" class="nav-link" data-scroll-target="#制作金字塔图的思路"><span class="header-section-number">5</span> 制作金字塔图的思路</a></li>
  <li><a href="#小结" id="toc-小结" class="nav-link" data-scroll-target="#小结"><span class="header-section-number">6</span> 小结</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="什么是人口金字塔图" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="什么是人口金字塔图"><span class="header-section-number">1</span> 什么是人口金字塔图？</h2>
<p>人口金字塔是用类似古埃及金字塔的形象描绘人口年龄和性别分布状况的图形。能表明人口现状及其发展类型，比如看一个地区或国家的人口结构类型是扩展型、稳定型或者收缩型。</p>
<p>图形的画法是：按男女人口年龄自然顺序自下而上在纵轴左右画成并列的横条柱，各条柱代表各个年龄组。底端标有按一定计算单位或百分比表示的人口数量。</p>
<p>下面我们介绍一下如何利用R画出人口金字塔图。</p>
</section>
<section id="用到哪些r包" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="用到哪些r包"><span class="header-section-number">2</span> 用到哪些R包？</h2>
<p>今天主要用到 dplyr包、reshape2包、ggplot2包和cowplot包。 dplyr包和reshape2包用来进行数据整理，ggplot2包和cowplot包用来画图和整合。</p>
</section>
<section id="加载这些r包" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="加载这些r包"><span class="header-section-number">3</span> 加载这些R包</h2>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-1_2919c4d0bfffd4177eb09a7ddb6496f6">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">library</span>(dplyr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'dplyr'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:stats':

    filter, lag</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    intersect, setdiff, setequal, union</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="fu">library</span>(reshape2)</span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="fu">library</span>(cowplot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="数据处理" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="数据处理"><span class="header-section-number">4</span> 数据处理</h2>
<p>首先需要把我们手里的现有数据读取到R工作环境，然后把数据调整为ggplot2包绘图所需要的格式。</p>
<p>我们看一下，我们目前的数据结构和变量基本信息吧，目前我们有一个数据框，数据框里有20列数据，第一列为性别(sex),其余分别为0<sub>，1</sub>，4~，…，85+岁组各年龄组的人口数据。</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-2_2cecb5de7c9d681e2516d41e57b65258">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>pop  <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"pop.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in read.table(file = file, header = header, sep = sep, quote = quote, :
incomplete final line found by readTableHeader on 'pop.csv'</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>pop <span class="ot">&lt;-</span> pop <span class="sc">%&gt;%</span></span>
<span id="cb8-2"><a href="#cb8-2"></a>  <span class="co">#把合计人口数去掉只保留男性和女性人口</span></span>
<span id="cb8-3"><a href="#cb8-3"></a>  <span class="fu">filter</span>(sex <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"男性"</span>,<span class="st">"女性"</span>))</span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="fu">head</span>(pop)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   sex     r0     r1      r5     r10     r15     r20     r25     r30     r35
1 男性 193565 924420 1186130 1158427 1130776 1254271 1426065 1291455 1279639
2 女性 176068 821772 1038768  991518 1002524 1162174 1365563 1235362 1208151
      r40     r45     r50    r55    r60    r65    r70    r75    r80    r85
1 1322747 1338809 1145094 941395 812746 622679 440440 300147 183825 102596
2 1261624 1292094 1101333 918208 801106 635924 467743 342476 228937 164663</code></pre>
</div>
</div>
<p>但是，ggplot2绘图需要读取纵向格式的数据，也就是说我们需要把目前的数据格式转换成两列，一列为性别，另一列为人口数。因此，我们需要把目前的数据转换成纵向结构数据。</p>
<p>reshape2包的melt函数可以把横向数据转换为纵向数据，id.vars参数指定保留的变量名称，其余的变量都转职置为纵向结构，转换为两列，一列存放变量名，一列存放变量值。variable.name指定存放变量名的那一列的变量名，value.name指定存放变量值的那一列的变量名。</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-3_3ee3674e58e1550dcaffa840c1c6640f">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a><span class="co"># 对横向数据进行转置，然后存入pop数据框</span></span>
<span id="cb10-2"><a href="#cb10-2"></a>pop <span class="ot">&lt;-</span> pop <span class="sc">%&gt;%</span></span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="co"># reshape2包的melt函数转置横向数据</span></span>
<span id="cb10-4"><a href="#cb10-4"></a>  <span class="fu">melt</span>(<span class="at">id.vars=</span><span class="fu">c</span>(<span class="st">"sex"</span>),</span>
<span id="cb10-5"><a href="#cb10-5"></a>       <span class="at">variable.name=</span><span class="st">"age"</span>,</span>
<span id="cb10-6"><a href="#cb10-6"></a>       <span class="at">value.name =</span> <span class="st">"pop"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>现在来看看转置后的数据吧</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-4_01230694d53edce0d1719cb9750c3069">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="fu">head</span>(pop)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   sex age     pop
1 男性  r0  193565
2 女性  r0  176068
3 男性  r1  924420
4 女性  r1  821772
5 男性  r5 1186130
6 女性  r5 1038768</code></pre>
</div>
</div>
<p>然后把目前pop数据框的age变量值进行转换，因为它的值就是人口金字塔中显示的年龄组的值。</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-5_668824e9a6a238105d3ab5b362c3acd1">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>pop<span class="ot">&lt;-</span>pop<span class="sc">%&gt;%</span></span>
<span id="cb13-2"><a href="#cb13-2"></a>  <span class="fu">mutate</span>(<span class="at">age=</span><span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">"r"</span>,<span class="st">""</span>,age)),</span>
<span id="cb13-3"><a href="#cb13-3"></a>         <span class="at">pop=</span><span class="fu">ifelse</span>(sex<span class="sc">==</span><span class="st">"男性"</span>,<span class="sc">-</span>pop,pop))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>绘制人口金字塔的时候，横条的长度采用跟年龄组人口数占相应人口的百分比来表示，因此计算人口百分比数据。</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-6_62fa430b3e19785ea9b6b03fd5ea65e6">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a>age_label<span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"0"</span>,<span class="st">"1-4"</span>,<span class="st">"5-9"</span>,<span class="st">"10-14"</span>,<span class="st">"15-19"</span>,<span class="st">"20-24"</span>,<span class="st">"25-29"</span>,<span class="st">"30-34"</span>,<span class="st">"35-39"</span>,<span class="st">"40-44"</span>,<span class="st">"45-49"</span>,<span class="st">"50-54"</span>,<span class="st">"55-59"</span>,<span class="st">"60-64"</span>,<span class="st">"65-69"</span>,<span class="st">"70-74"</span>,<span class="st">"75-79"</span>,<span class="st">"80-84"</span>,<span class="st">"85-"</span>)</span>
<span id="cb14-2"><a href="#cb14-2"></a>pop <span class="ot">&lt;-</span> pop<span class="sc">%&gt;%</span></span>
<span id="cb14-3"><a href="#cb14-3"></a>  <span class="fu">group_by</span>(sex)<span class="sc">%&gt;%</span></span>
<span id="cb14-4"><a href="#cb14-4"></a>  <span class="fu">mutate</span>(<span class="at">pop_rate=</span>pop<span class="sc">/</span><span class="fu">sum</span>(pop)<span class="sc">*</span><span class="dv">100</span>)<span class="sc">%&gt;%</span></span>
<span id="cb14-5"><a href="#cb14-5"></a>  <span class="fu">mutate</span>(<span class="at">pop_rate=</span><span class="fu">ifelse</span>(sex<span class="sc">==</span><span class="st">"男性"</span>,<span class="sc">-</span>pop_rate,pop_rate))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>然后把人口数据拆分成男性和女性两个数据框，并把这个两个数据框存入列表ct</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-7_9835224b9fc3aed6aa0141c1e14da11b">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a>ct <span class="ot">&lt;-</span> pop<span class="sc">%&gt;%</span><span class="fu">group_by</span>(sex)<span class="sc">%&gt;%</span><span class="fu">group_split</span>()</span>
<span id="cb15-2"><a href="#cb15-2"></a>ct</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;list_of&lt;
  tbl_df&lt;
    sex     : character
    age     : double
    pop     : integer
    pop_rate: double
  &gt;
&gt;[2]&gt;
[[1]]
# A tibble: 19 × 4
   sex     age     pop pop_rate
   &lt;chr&gt; &lt;dbl&gt;   &lt;int&gt;    &lt;dbl&gt;
 1 女性      0  176068     1.09
 2 女性      1  821772     5.07
 3 女性      5 1038768     6.41
 4 女性     10  991518     6.11
 5 女性     15 1002524     6.18
 6 女性     20 1162174     7.17
 7 女性     25 1365563     8.42
 8 女性     30 1235362     7.62
 9 女性     35 1208151     7.45
10 女性     40 1261624     7.78
11 女性     45 1292094     7.97
12 女性     50 1101333     6.79
13 女性     55  918208     5.66
14 女性     60  801106     4.94
15 女性     65  635924     3.92
16 女性     70  467743     2.88
17 女性     75  342476     2.11
18 女性     80  228937     1.41
19 女性     85  164663     1.02

[[2]]
# A tibble: 19 × 4
   sex     age      pop pop_rate
   &lt;chr&gt; &lt;dbl&gt;    &lt;int&gt;    &lt;dbl&gt;
 1 男性      0  -193565   -1.13 
 2 男性      1  -924420   -5.42 
 3 男性      5 -1186130   -6.95 
 4 男性     10 -1158427   -6.79 
 5 男性     15 -1130776   -6.63 
 6 男性     20 -1254271   -7.35 
 7 男性     25 -1426065   -8.36 
 8 男性     30 -1291455   -7.57 
 9 男性     35 -1279639   -7.50 
10 男性     40 -1322747   -7.76 
11 男性     45 -1338809   -7.85 
12 男性     50 -1145094   -6.71 
13 男性     55  -941395   -5.52 
14 男性     60  -812746   -4.77 
15 男性     65  -622679   -3.65 
16 男性     70  -440440   -2.58 
17 男性     75  -300147   -1.76 
18 男性     80  -183825   -1.08 
19 男性     85  -102596   -0.602</code></pre>
</div>
</div>
<p>为了使用方便，我们编制一个函数，并利用lapply函数把ct列表放入进去，这样就可以自动生成横向条形图。</p>
</section>
<section id="制作金字塔图的思路" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="制作金字塔图的思路"><span class="header-section-number">5</span> 制作金字塔图的思路</h2>
<p>我们先编写一个函数，实现对列表数据进行处理，判断如果是男性数据的话则生成左侧横向条形图，如果是女性数据的话则生成右侧横向条形图，然后把利用cowplot把左侧条形图和右侧条形图组成一个金字塔图。</p>
<p>上程序：</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-8_83fdc5f51f0bfdffec602bb205c25be1">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a><span class="co"># top_value &lt;-  max(abs(pop$pop_rate)) </span></span>
<span id="cb17-2"><a href="#cb17-2"></a>p<span class="ot">&lt;-</span> <span class="fu">lapply</span>(ct,<span class="cf">function</span>(x) {</span>
<span id="cb17-3"><a href="#cb17-3"></a>  sexx <span class="ot">&lt;-</span> x[<span class="dv">1</span>,<span class="fu">c</span>(<span class="st">"sex"</span>)]</span>
<span id="cb17-4"><a href="#cb17-4"></a>  abslabel <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {<span class="fu">paste</span>(<span class="fu">abs</span>(x),<span class="st">"%"</span>,<span class="at">sep=</span><span class="st">""</span>)}</span>
<span id="cb17-5"><a href="#cb17-5"></a>  mycolor <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(sexx<span class="sc">==</span><span class="st">"男性"</span>,<span class="fu">paste</span>(<span class="st">"steelblue"</span>),<span class="fu">paste</span>(<span class="st">"red"</span>))</span>
<span id="cb17-6"><a href="#cb17-6"></a>  pp<span class="ot">&lt;-</span><span class="fu">ggplot</span>(x) <span class="sc">+</span> </span>
<span id="cb17-7"><a href="#cb17-7"></a>    <span class="fu">geom_bar</span>(<span class="fu">aes</span>(<span class="at">x=</span>pop_rate,<span class="at">y=</span><span class="fu">factor</span>(age,<span class="at">labels=</span>age_label)), <span class="at">stat =</span> <span class="st">"identity"</span>,<span class="at">color=</span><span class="st">"white"</span>,<span class="at">width=</span><span class="fl">0.9</span>,<span class="at">fill=</span><span class="fu">ifelse</span>(x<span class="sc">$</span>pop_rate<span class="sc">&gt;</span><span class="dv">0</span>,<span class="st">'#e31a1c'</span>,<span class="st">'#1f78b4'</span>))<span class="sc">+</span></span>
<span id="cb17-8"><a href="#cb17-8"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(),<span class="at">limits=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">9.9</span>),<span class="at">labels=</span>abslabel)<span class="sc">+</span></span>
<span id="cb17-9"><a href="#cb17-9"></a>    <span class="fu">xlab</span>(<span class="fu">ifelse</span>(sexx<span class="sc">==</span><span class="st">"男性"</span>,<span class="st">"男性"</span>,<span class="st">"女性"</span>))<span class="sc">+</span></span>
<span id="cb17-10"><a href="#cb17-10"></a>    <span class="fu">theme_void</span>()<span class="sc">+</span></span>
<span id="cb17-11"><a href="#cb17-11"></a>    <span class="fu">theme</span>(</span>
<span id="cb17-12"><a href="#cb17-12"></a>      <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb17-13"><a href="#cb17-13"></a>      <span class="at">panel.border =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb17-14"><a href="#cb17-14"></a>      <span class="at">panel.grid=</span><span class="fu">element_blank</span>(),</span>
<span id="cb17-15"><a href="#cb17-15"></a>      <span class="at">panel.grid.major =</span><span class="fu">element_blank</span>(),</span>
<span id="cb17-16"><a href="#cb17-16"></a>      <span class="at">axis.ticks.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb17-17"><a href="#cb17-17"></a>      <span class="at">axis.line.y=</span><span class="fu">element_blank</span>(),</span>
<span id="cb17-18"><a href="#cb17-18"></a>      <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">face=</span><span class="st">"bold"</span>),</span>
<span id="cb17-19"><a href="#cb17-19"></a>      <span class="at">axis.text.y =</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb17-20"><a href="#cb17-20"></a>      <span class="at">axis.title.x=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">12</span>)</span>
<span id="cb17-21"><a href="#cb17-21"></a>    )</span>
<span id="cb17-22"><a href="#cb17-22"></a>  <span class="cf">if</span> (sexx<span class="sc">==</span><span class="st">"男性"</span>){ pp<span class="ot">&lt;-</span> pp<span class="sc">+</span> <span class="fu">theme</span>(<span class="at">axis.text.y =</span><span class="fu">element_blank</span>())<span class="sc">+</span><span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(),<span class="at">limits=</span><span class="fu">c</span>(<span class="sc">-</span><span class="fl">9.9</span>,<span class="dv">0</span>),<span class="at">labels=</span>abslabel)</span>
<span id="cb17-23"><a href="#cb17-23"></a>  }</span>
<span id="cb17-24"><a href="#cb17-24"></a>  <span class="fu">return</span>(pp)</span>
<span id="cb17-25"><a href="#cb17-25"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Scale for x is already present.
Adding another scale for x, which will replace the existing scale.</code></pre>
</div>
</div>
<p>上面的程序有已经把生成的左侧和右侧条形图放入列表p，下面把列表的第一个元素和第二个元素利用cowplot组合起来就是一个金字塔图了。</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-9_9a7f81c0d506cd7011bd49c7b3d71b3a">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a><span class="co"># 利用plot_grid来组合p列表元素，进行横向拼接，存入pyramid</span></span>
<span id="cb19-2"><a href="#cb19-2"></a>pyramid <span class="ot">&lt;-</span> <span class="fu">plot_grid</span>(p[[<span class="dv">1</span>]],p[[<span class="dv">2</span>]],<span class="at">ncol=</span><span class="dv">2</span>,<span class="at">align=</span><span class="st">"hv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>我们来看看最终的金字塔图的吧。</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-10_536195044a20c99f3b3ec5bf5e9bba35">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a>pyramid</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" alt="科研作图，人口金字塔图" width="672"></p>
</div>
</div>
</section>
<section id="小结" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="小结"><span class="header-section-number">6</span> 小结</h2>
<p>本篇文章介绍了如何利用R语言制作人口金字塔图，利用本程序的思路，稍微修改，可以批量制作金字塔图。</p>
<p>如果你对本篇文章有任何建议，请在页面进行评论吧！</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="gigu003/chenqcomments" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Copyright@Qiong Chen</div>   
    <div class="nav-footer-center">豫ICP备2021032022号</div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/gigu003">
      <i class="bi bi-github" role="img" aria-label="Qiong@GitHub">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="../../qsight/index.xml">
      <i class="bi bi-rss" role="img" aria-label="RSS">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>



</body></html>