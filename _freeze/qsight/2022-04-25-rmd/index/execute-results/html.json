{
  "hash": "bb5fc90493660bd1e451ef68db58f19d",
  "result": {
    "markdown": "---\ntitle: 利用Rmd代码选项输出动态金字塔图\ndate: '2022-04-25'\nslug: rmd\nlink: https://chenq.site/tech/2022-rmd/\ncategories:\n  - R\n  - 科研作图\nkeywords:\n  - R语言\n  - ggplot2\n  - 科研作图\n  - 人口金字塔图\nimage: cover.png\n---\n\n\n***人口金字塔图***可以形象的展示人口结构，而动态人口金字塔则可以直观的展示历年人口结构的变化情况，从而可以直观的对人口数据进行质量控制，本篇博文讲介绍如何利用R语言Rmd文档输出动态人口金字塔图。\n\n\n首先，我们先看一下需要准备的人口数据结构,数据集包含某个地区男性和女性每年的不同年龄组的人口数（5岁一组），年份变量为year，性别变量为sex，人口数据分别为r0、r1、r5、r10、... 、r85等。\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata<-read.csv(\"population.csv\")\nhead(data)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n  year  sex   r0    r1    r5   r10   r15   r20   r25   r30   r35   r40   r45\n1 2009 男性 5992 22345 25843 26164 43929 54912 58033 47602 54539 50224 40894\n2 2009 女性 5857 22146 24908 25507 48444 47977 52270 46133 48743 44852 39429\n3 2010 男性 6583 39619 42627 39820 45037 54131 34227 34382 42964 47668 38828\n4 2010 女性 5484 30619 32323 31418 40701 56864 36506 34890 42224 48566 40392\n5 2011 男性 5798 33931 40512 38334 47433 49693 33125 34833 47700 50181 42654\n6 2011 女性 4983 29613 34439 33614 43799 51384 34154 35228 45182 47480 40500\n    r50   r55   r60   r65   r70  r75  r80  r85\n1 40855 29236 18125 13376 10564 6242 2369  577\n2 39600 28104 18908 14984 11186 6425 3363 1408\n3 28353 32932 24141 16239 11913 8333 4241 1970\n4 28425 32685 23329 16139 12245 9821 5835 3879\n5 33943 33498 22853 15307 12274 8428 4032 1694\n6 32253 32249 22456 15207 12998 9966 5459 3507\n```\n:::\n:::\n\n\n## 作图思路\n首先把现有的数据从**宽数据**转换为**长数据**，然后对数据进行简单处理，最后利用for循环和ggplot2输出多个年份的人口金字塔图，然后利用code chunk 选项输出动态图片。\n\n## 数据处理\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(dplyr)\nlibrary(tidyr)\ndata <- data %>%\n  ## 把宽数据转换为长数据\n  gather(\"agegrp\",\"rks\",-year,-sex)%>%\n  ## 整理年龄组变量，添加标签转换显示格式\n  mutate(agegrp=as.numeric(gsub(\"[^0-9]\", \"\", agegrp)),\n         agegrp=factor(agegrp,labels = c(\"0\",\"1-4\",\"5-9\",\"10-14\",\"15-19\",\"20-24\",\"25-29\",\"30-34\",\"35-39\",\"40-44\",\"45-49\",\"50-54\",\"55-59\",\"60-64\",\"65-69\",\"70-74\",\"75-79\",\"80-84\",\"85+\")))%>%\n  group_by(year)%>%\n  ## 把男性人口数转换为负值，以是条图显示在左侧\n  mutate(rks=round(rks/sum(rks),4),\n         rks=ifelse(sex==\"男性\",-rks,rks))\n```\n:::\n\n\n\n## Rmd code chunk 选项\n利用Rmd文档可以输出成很多种格式的输出结果，比如word、ppt、网页、pdf等，本篇博文介绍的为输出到网页显示动态图片。\n\n在Rmd文档中插入r语言代码块，代码块的选项设置为fig.show='animate',animation.hook='gifski'，当代码块内的语句生成多个图片的时候，会自动设置为动画播放。\n\n## 利用for循环和ggplot2制作金字塔图\n在代码块内部，使用for循环和ggplot2生成多个年份的人口金子塔图即可。\n\n\n::: {.cell animation.hook='gifski'}\n\n```{.r .cell-code}\n## 加载ggplot2包\nlibrary(ggplot2)\n## 建立for循环\nfor (i in 2011:2017) {\n data %>% \n    filter(year==i) %>%\n  ggplot(aes(x=factor(agegrp),y=rks,fill=sex)) +\n  geom_bar(stat = \"identity\",position = \"identity\",color=\"black\",linewidth=0.25)+\n  geom_text(aes(label=paste0(abs(rks) * 100, '%')))+\n  coord_flip()+\n  theme_classic()+\n  xlab(\"\")+\n  ylab(\"\")+\n  scale_y_continuous(limits = c(-0.08,0.08),breaks=seq(-0.08,0.08,0.02),labels = function(x) paste0(abs(x) * 100, '%'))+\n  labs(title=\"历年人口金字塔变化情况\",subtitle=paste(i))+\n  theme(legend.position = c(0.1,0.9),\n        legend.title = element_blank(),\n        strip.text = element_text(size=10, face=\"bold.italic\"),\n        strip.background = element_rect(color=\"white\", size=0),\n        axis.text=element_text(size=10),\n        axis.title=element_text(size=12, face=\"bold\"),\n        plot.title = element_text(face=\"bold\", size=14, hjust = 0.5),\n        plot.subtitle=element_text(face=\"bold\",size=20,hjust=0.8))->p\n  plot(p)\n}\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: The `size` argument of `element_rect()` is deprecated as of ggplot2 3.4.0.\nℹ Please use the `linewidth` argument instead.\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-3-.gif){width=672}\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}